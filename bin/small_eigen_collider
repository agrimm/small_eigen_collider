$:.unshift File.join(File.dirname(__FILE__), "..", "lib")
require "small_eigen_collider"

raise "Read the README, and understand this can harm your computer." unless File.exist?("i_understand_the_risks.txt")

$VERBOSE = nil

yaml_filename = "tasks.yml"

def determine_output_filename
  # FIXME be able to include the ruby implementation's version
  # FIXME should the output filename be chosen by the program like this?
  ruby_engine = defined?(RUBY_ENGINE) ? RUBY_ENGINE : "unknown_engine"
  output_filename = [ruby_engine, RUBY_VERSION, RUBY_PATCHLEVEL, "output.txt"].join("_")
  output_filename
end

if File.exist?(yaml_filename)
  task_list = SmallEigenCollider::TaskList.new_using_yaml(yaml_filename)
  task_list.run_and_log_each_task(determine_output_filename)
else
  iterations = 200
  task_list = SmallEigenCollider::TaskList.new_using_creator(iterations)
  task_list.add_filter(:success_only)
  task_list.add_filter(:implementation_dependent)
  task_list.run_and_log_each_task(determine_output_filename)
  task_list.dump_tasks_to_yaml(yaml_filename)
end
