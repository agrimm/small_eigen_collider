$:.unshift File.join(File.dirname(__FILE__), "..", "lib")

require "yaml"
require "array_chopper"

raise "known_bad.yml doesn't exist - this file is required to indicate what should crash the ruby" unless File.exist?("known_bad.yml")

if __FILE__ == $0
  bad_array = YAML.load_file("known_bad.yml")

  array_test = Proc.new do |array|
    STDERR.puts "Array size is #{array.size}"
    sleep 1
    File.open("tasks.yml", "w") {|f| YAML.dump(array, f)}
    result = system("ruby bin/small_eigen_collider")
    STDERR.puts "Result for array size of #{array.size} was #{result.inspect}"
    result
  end

  array_chopper = ArrayChopper.new(bad_array, array_test)
  array_chopper.run
  File.open("minimal_failure.yml", "w") {|f| YAML.dump(array_chopper.minimal_failure, f)}
end
